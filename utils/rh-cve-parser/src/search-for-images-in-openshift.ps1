function Get-Current_Installed_Openshift_Images {
    $images_raw = (oc get deployments,pods,statefulsets,daemonsets,jobs,cronjobs --all-namespaces -o json) | ConvertFrom-Json
    $openshift_installed_images = @()
    Write-Output "Starting collecting images from openshift"
    $images_raw | Get-Member | Out-Host -Paging
    foreach ($item in $images_raw.items){
        $containers = $item.spec.template.spec.containers
        foreach ($container in $containers){
            $image_name, $image_sha = $container.image -Split "@"
            Write-Output "$image_name - $image_sha"
            $openshift_installed_images += $image_name
        }
    }
    Write-Output "Done collecting images from openshift"
    return $openshift_installed_images

}


$results = Get-Content $PSScriptRoot/result/relevant_CVEs.md
$images_by_cve = @{}


foreach ($issue in $results){
    # We're not using the first value which is always empty as the result starts with a pipe.
    $_, $cve, $level, $desc, $images = $issue -Split "\|"
    Write-Output $issue
    Write-Output "CVE $cve, level $level, desc $desc ::"

    $cve_images = $images -Split "<br/>"
    foreach ($cve_image in $cve_images){
        Write-Output "CVE image for $cve is $cve_image"
        $images_by_cve[$cve_image] = $cve
    }
    Write-Output "----"
}

$openshift_images = Get-Current_Installed_Openshift_Images | Select-Object -Unique

Write-Output $openshift_images


